name: Publish Alpine Repository

on:
  workflow_call:
    inputs:
      alpine-version:
        description: 'Alpine version (edge, v3.19, v3.20, etc.)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      alpine-version:
        description: 'Alpine version to rebuild'
        required: true
        type: choice
        options:
          - edge
          - v3.21
          - v3.20
          - v3.19
          - v3.18

permissions:
  contents: write
  pages: write

jobs:
  publish-repository:
    name: Publish Alpine Repository
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git configuration
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Setup signing keys
        run: |
          mkdir -p ~/.abuild
          mkdir -p .abuild-keys

          # Install private key for APKINDEX signing
          echo "${{ secrets.RSA_PRIVATE_KEY }}" > .abuild-keys/jambox-65ea124a.rsa
          chmod 600 .abuild-keys/jambox-65ea124a.rsa

          # Install public key for package verification
          echo "${{ secrets.RSA_PUBLIC_KEY }}" > .abuild-keys/jambox-65ea124a.rsa.pub
          chmod 644 .abuild-keys/jambox-65ea124a.rsa.pub

          # Validate keys using openssl (without exposing secrets)
          echo "Validating private key..."
          if openssl rsa -in .abuild-keys/jambox-65ea124a.rsa -check -noout 2>&1; then
            echo "  ✓ Private key is valid"
            openssl rsa -in .abuild-keys/jambox-65ea124a.rsa -text -noout 2>&1 | grep "Private-Key:"
          else
            echo "  ✗ Private key is INVALID or malformed"
            exit 1
          fi

          echo "Validating public key..."
          if openssl rsa -pubin -in .abuild-keys/jambox-65ea124a.rsa.pub -text -noout 2>&1 | grep "Public-Key:"; then
            echo "  ✓ Public key is valid"
          else
            echo "  ✗ Public key is INVALID or malformed"
            exit 1
          fi

          echo "Verifying key pair match..."
          PRIV_MOD=$(openssl rsa -in .abuild-keys/jambox-65ea124a.rsa -modulus -noout 2>/dev/null | md5sum)
          PUB_MOD=$(openssl rsa -pubin -in .abuild-keys/jambox-65ea124a.rsa.pub -modulus -noout 2>/dev/null | md5sum)
          if [ "$PRIV_MOD" = "$PUB_MOD" ]; then
            echo "  ✓ Private and public keys are a matching pair"
          else
            echo "  ✗ Private and public keys DO NOT MATCH"
            exit 1
          fi

          echo "✓ All signing keys validated and staged"

      - name: Download build artifacts (if called from build workflow)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: new-packages

      - name: Organize new packages by architecture
        run: |
          mkdir -p packages
          # Check if artifacts were downloaded
          if [ -d "new-packages" ]; then
            echo "Found build artifacts - organizing packages..."
            for arch_dir in new-packages/packages-*/; do
              if [ -d "$arch_dir" ]; then
                arch=$(basename "$arch_dir" | sed 's/packages-//')
                mkdir -p "packages/${arch}"
                cp "$arch_dir"*.apk "packages/${arch}/" 2>/dev/null || true
              fi
            done
            ls -la packages/*/ 2>/dev/null || echo "No packages organized"
          else
            echo "No build artifacts found (normal for manual workflow_dispatch)"
          fi

      - name: Sync existing repository from gh-pages branch
        run: |
          BRANCH="${{ inputs.alpine-version }}"
          mkdir -p "${BRANCH}/JamBox"

          echo "Fetching existing repository from gh-pages for ${BRANCH}..."

          # Use git to atomically fetch existing packages from gh-pages
          git fetch origin gh-pages --depth=1 2>/dev/null || {
            echo "No gh-pages branch found (normal for first run)"
            exit 0
          }

          # Sparse checkout only the Alpine version we need
          git checkout origin/gh-pages -- "${BRANCH}/" 2>/dev/null || {
            echo "No existing repository for ${BRANCH} (normal for first run)"
            exit 0
          }

          # Count existing packages
          echo ""
          echo "Existing packages:"
          for arch in x86_64 aarch64 armv7 armhf; do
            if [ -d "${BRANCH}/JamBox/${arch}" ]; then
              COUNT=$(find "${BRANCH}/JamBox/${arch}" -name "*.apk" 2>/dev/null | wc -l)
              echo "  ${arch}: ${COUNT} packages"
            else
              echo "  ${arch}: 0 packages"
            fi
          done

      - name: Merge new packages with existing repository
        run: |
          BRANCH="${{ inputs.alpine-version }}"
          echo "=== Merging new packages with existing repository ==="

          # Ensure JamBox directories exist for all architectures
          for arch in x86_64 aarch64 armv7 armhf; do
            mkdir -p "${BRANCH}/JamBox/${arch}"

            BEFORE=$(find "${BRANCH}/JamBox/${arch}" -name "*.apk" 2>/dev/null | wc -l)

            # Copy new packages (overwrites old versions with same name)
            if [ -d "packages/${arch}" ] && ls packages/${arch}/*.apk 2>/dev/null | head -1 >/dev/null; then
              echo "Adding new packages for ${arch}..."
              cp packages/${arch}/*.apk "${BRANCH}/JamBox/${arch}/"
              AFTER=$(find "${BRANCH}/JamBox/${arch}" -name "*.apk" 2>/dev/null | wc -l)
              NEW=$((AFTER - BEFORE))
              echo "  Added/updated ${NEW} packages (${BEFORE} → ${AFTER} total)"
            else
              echo "No new packages for ${arch} (${BEFORE} existing)"
            fi
          done

      - name: Generate APKINDEX files
        uses: ./.github/actions/generate-apkindex
        with:
          alpine-version: ${{ inputs.alpine-version }}

      - name: Validate APKINDEX integrity
        uses: ./.github/actions/validate-apkindex
        with:
          alpine-version: ${{ inputs.alpine-version }}

      - name: Repository summary
        run: |
          BRANCH="${{ inputs.alpine-version }}"
          echo ""
          echo "=== Final Repository Summary for ${BRANCH} ==="
          for arch in x86_64 aarch64 armv7 armhf; do
            COUNT=$(find "${BRANCH}/JamBox/${arch}" -name "*.apk" 2>/dev/null | wc -l)
            echo "  ${arch}: ${COUNT} packages"
          done

      - name: Publish to GitHub Pages
        run: |
          ALPINE_VERSION="${{ inputs.alpine-version }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save the newly built repository to a temp location
          mkdir -p /tmp/new-repo
          cp -r "${ALPINE_VERSION}" /tmp/new-repo/

          # Fetch and checkout gh-pages branch
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git checkout gh-pages

          # Ensure destination exists
          mkdir -p "${ALPINE_VERSION}"

          # Copy new packages over existing ones
          # - Same package-version: overwrites (updates)
          # - Different versions: both kept (preserves pins)
          cp -r /tmp/new-repo/"${ALPINE_VERSION}"/* "${ALPINE_VERSION}/"

          # Disable Jekyll
          touch .nojekyll

          # Add all changes
          git add "${ALPINE_VERSION}" .nojekyll

          # Commit changes
          git commit -m "Update Alpine ${ALPINE_VERSION} repository

          Packages updated by build #${{ github.run_number }}

          - New packages added
          - Existing packages kept (no deletions)
          - APKINDEX rebuilt" || echo "No changes to commit"

          # Push to gh-pages
          git push origin gh-pages

      - name: Generate repository URL
        run: |
          BRANCH="${{ inputs.alpine-version }}"
          echo ""
          echo "=========================================="
          echo "Alpine Repository Published!"
          echo "=========================================="
          echo ""
          echo "Add to /etc/apk/repositories:"
          echo ""
          echo "  @jambox https://jambox-it.github.io/aports/${BRANCH}/JamBox"
          echo ""
          echo "Install packages with:"
          echo "  apk add package-name@jambox"
          echo ""
          echo "Note: apk automatically appends your architecture (x86_64, aarch64, armv7, armhf)"

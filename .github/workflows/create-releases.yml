name: Create GitHub Releases

on:
  workflow_call:
    inputs:
      alpine-version:
        required: true
        type: string
        description: Alpine version (edge, v3.19, etc.)

permissions:
  contents: write

jobs:
  create-release:
    name: Create Per-Package Releases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-packages

      - name: Create per-package releases
        run: |
          # Track created releases to avoid duplicates
          declare -A CREATED_RELEASES

          for arch_dir in all-packages/packages-*/; do
            arch=$(basename "$arch_dir" | sed 's/packages-//')

            for pkg in "$arch_dir"*.apk; do
              if [ ! -f "$pkg" ]; then
                continue
              fi

              # Extract package name and version
              # Format: pkgname-pkgver-rN-arch.apk
              basename=$(basename "$pkg" .apk)

              # Remove arch suffix
              without_arch="${basename%-${arch}}"

              # Extract pkgname-pkgver-rN
              # This regex handles package names with hyphens
              if [[ "$without_arch" =~ ^(.+)-([0-9]+\.[0-9]+\.[0-9]+.*)-r([0-9]+)$ ]]; then
                pkgname="${BASH_REMATCH[1]}"
                pkgver="${BASH_REMATCH[2]}"
                pkgrel="${BASH_REMATCH[3]}"
              elif [[ "$without_arch" =~ ^(.+)-([0-9]+\.[0-9]+.*)-r([0-9]+)$ ]]; then
                pkgname="${BASH_REMATCH[1]}"
                pkgver="${BASH_REMATCH[2]}"
                pkgrel="${BASH_REMATCH[3]}"
              else
                echo "‚ö†Ô∏è  Could not parse version from: $basename"
                continue
              fi

              # Append Alpine version to tag to avoid conflicts between branches
              release_tag="${pkgname}-${pkgver}-r${pkgrel}_alpine${{ inputs.alpine-version }}"

              # Skip if we already created this release
              if [ -n "${CREATED_RELEASES[$release_tag]}" ]; then
                echo "  Adding $basename to existing release $release_tag"
                mkdir -p "releases/${release_tag}"
                cp "$pkg" "releases/${release_tag}/"
                continue
              fi

              echo "üì¶ Creating release for: $release_tag"
              mkdir -p "releases/${release_tag}"
              cp "$pkg" "releases/${release_tag}/"
              CREATED_RELEASES[$release_tag]=1
            done
          done

          # Create releases for each unique package version
          for release_dir in releases/*/; do
            if [ ! -d "$release_dir" ]; then
              continue
            fi

            release_tag=$(basename "$release_dir")

            # Generate release notes
            cat > "${release_dir}/RELEASE.md" << EOF
          # ${release_tag}

          Alpine Linux package built for Alpine ${{ inputs.alpine-version }}.

          ## Architectures

          EOF

            # List all architectures in this release
            for apk in "${release_dir}"*.apk; do
              if [ -f "$apk" ]; then
                echo "- $(basename "$apk")" >> "${release_dir}/RELEASE.md"
              fi
            done

            cat >> "${release_dir}/RELEASE.md" << EOF

          ## Installation

          \`\`\`bash
          # Download for your architecture
          wget https://github.com/${{ github.repository }}/releases/download/${release_tag}/<package-file>.apk

          # Install
          apk add --allow-untrusted <package-file>.apk
          \`\`\`

          Or use the JamBox repository:
          \`\`\`bash
          apk add ${release_tag%-r*}@jambox
          \`\`\`
          EOF

            # Create the GitHub release
            echo "Creating GitHub release: $release_tag"
            gh release create "$release_tag" \
              "${release_dir}"*.apk \
              --title "$release_tag" \
              --notes-file "${release_dir}/RELEASE.md" \
              --repo "${{ github.repository }}" || echo "‚ö†Ô∏è  Release $release_tag may already exist"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

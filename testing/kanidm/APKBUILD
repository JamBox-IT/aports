maintainer="Corey DeLasaux <cordelster@gmail.com>"
pkgname=kanidm
pkgver=1.9.0
pkgrel=0
pkgdesc="A identity management server, acting as an authority on account information"
url="https://kanidm.github.io"
arch="all !x86 !armhf !armv7 !riscv64"
license="MPL-2.0"
depends="
	$pkgname-clients
	$pkgname-server
	$pkgname-unixd-clients
	"
makedepends="
	bash
	bc
	brotli
	cargo
	cargo-auditable
	clang-dev
	cmake
	samurai
	eudev-dev
	linux-pam-dev
	openssl-dev
	py3-setuptools
	python3-dev
	rsync
	"
install="
	$pkgname-server.pre-install
	$pkgname-unixd-clients.pre-install
	"
subpackages="
	$pkgname-bash-completion
	$pkgname-clients
	$pkgname-ipa-sync:ipa_sync
	$pkgname-ldap-sync:ldap_sync
	$pkgname-openrc
	$pkgname-radiusd:radiusd
	$pkgname-server
	$pkgname-unixd-clients:unixd_clients
	$pkgname-zsh-completion
	$pkgname-rlm_python
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/kanidm/kanidm/archive/refs/tags/v$pkgver.tar.gz
	initgroups-hooks.patch
	jambox-server.base_htmx.patch
	release_alpine.toml
	kanidmd.initd
	kanidm-unixd.initd
	kanidm-unixd-tasks.initd
	use-var-lib-kanidm.patch
	server-https-port.patch
	"
options="!check net" # takes too long, downloading rust crates

_profile="release_alpine"
_cargoopts="--frozen --release
	--package daemon
	--package kanidm-ipa-sync
	--package kanidm-ldap-sync
	--package kanidm_tools
	--package kanidm_unix_int
	--package nss_kanidm
	--package pam_kanidm
	"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
	install -Dm644 "$srcdir"/release_alpine.toml -t libs/profiles/
}

build() {
	KANIDM_BUILD_PROFILE="$_profile" \
	cargo auditable build $_cargoopts
}

check() {
	export RUSTFLAGS="$RUSTFLAGS -C link-args=-Wl,-z,stack-size=2097152"
	KANIDM_BUILD_PROFILE="$_profile" \
	cargo test $_cargoopts -- --test-threads=1
}

package() {
	# openrc
	install -Dm755 "$srcdir"/kanidmd.initd "$pkgdir"/etc/init.d/kanidmd
	install -Dm755 "$srcdir"/kanidm-unixd.initd "$pkgdir"/etc/init.d/kanidm-unixd
	install -Dm755 "$srcdir"/kanidm-unixd-tasks.initd "$pkgdir"/etc/init.d/kanidm-unixd-tasks

	# zsh completion
	install -Dm644 target/release/build/completions/_kanidm -t "$pkgdir"/usr/share/zsh/site-functions/
	install -Dm644 target/release/build/completions/_kanidmd -t "$pkgdir"/usr/share/zsh/site-functions/
	install -Dm644 target/release/build/completions/_kanidm_ssh_authorizedkeys_direct -t "$pkgdir"/usr/share/zsh/site-functions/
	install -Dm644 target/release/build/completions/_kanidm_ssh_authorizedkeys -t "$pkgdir"/usr/share/zsh/site-functions/
	install -Dm644 target/release/build/completions/_kanidm_unix -t "$pkgdir"/usr/share/zsh/site-functions/

	# bash completion
	install -Dm644 target/release/build/completions/kanidm.bash -t "$pkgdir"/usr/share/bash-completion/completions/
	install -Dm644 target/release/build/completions/kanidmd.bash -t "$pkgdir"/usr/share/bash-completion/completions/
	install -Dm644 target/release/build/completions/kanidm_ssh_authorizedkeys_direct.bash -t "$pkgdir"/usr/share/bash-completion/completions/
	install -Dm644 target/release/build/completions/kanidm_ssh_authorizedkeys.bash -t "$pkgdir"/usr/share/bash-completion/completions/
	install -Dm644 target/release/build/completions/kanidm_unix.bash -t "$pkgdir"/usr/share/bash-completion/completions/
}

clients() {
	pkgdesc="Kanidm client to interact with kanidm identity management server"
	depends=""

	install -Dm755 "$builddir"/target/release/kanidm -t "$subpkgdir"/usr/bin/
	install -Dm644 "$builddir"/examples/config -t "$subpkgdir"/etc/kanidm/
}

server() {
	pkgdesc="Kanidm server for idendity management, OAuth2 / OpenID Connect, Webauthn (level 3), ssh key management"
	depends=""

	install -Dm755 "$builddir"/target/release/kanidmd -t "$subpkgdir"/usr/bin/
	install -Dm644 "$builddir"/examples/server.toml -t "$subpkgdir"/etc/kanidm/

	install -dv "$subpkgdir"/usr/share/kanidm/ui/hpkg
	cp -r "$builddir"/server/core/static/* "$subpkgdir"/usr/share/kanidm/ui/hpkg
}

unixd_clients() {
	pkgdesc="Kanidm localhost resolver to resolve posix identities to a kanidm instance"
	depends=""

	install -Dm755 "$builddir"/target/release/kanidm_ssh_authorizedkeys -t "$subpkgdir"/usr/bin/
	install -Dm755 "$builddir"/target/release/kanidm_ssh_authorizedkeys_direct -t "$subpkgdir"/usr/bin/
	install -Dm755 "$builddir"/target/release/kanidm-unix -t "$subpkgdir"/usr/bin/
	install -Dm755 "$builddir"/target/release/kanidm_unixd -t "$subpkgdir"/usr/bin/
	install -Dm755 "$builddir"/target/release/kanidm_unixd_tasks -t "$subpkgdir"/usr/bin/

	install -Dm755 "$builddir"/target/release/libnss_kanidm.so "$subpkgdir"/usr/lib/libnss_kanidm.so.2
	install -Dm755 "$builddir"/target/release/libpam_kanidm.so "$subpkgdir"/usr/lib/security/pam_kanidm.so

	install -Dm644 "$builddir"/examples/unixd -t "$subpkgdir"/etc/kanidm/
}

ldap_sync() {
	pkgdesc="Kanidm LDAP sync tool for migrating/sync from LDAP directories"
	depends="$pkgname-clients"

	install -Dm755 "$builddir"/target/release/kanidm-ldap-sync -t "$subpkgdir"/usr/bin/
}

ipa_sync() {
	pkgdesc="Kanidm IPA sync tool for migrating/sync from FreeIPA directories"
	depends="$pkgname-clients"

	install -Dm755 "$builddir"/target/release/kanidm-ipa-sync -t "$subpkgdir"/usr/bin/
}

radiusd() {
	pkgdesc="Kanidm FreeRADIUS integration module"
	depends="python3 freeradius freeradius-python $pkgname-clients"
  arch="noarch"
  
	# Install the Python RADIUS module
	install -Dm644 "$builddir"/rlm_python/mods-available/python3 "$subpkgdir"/etc/raddb/mods-available/kanidm
	install -Dm644 "$builddir"/rlm_python/sites-available/default "$subpkgdir"/etc/raddb/sites-available/kanidm-default
	
}

rlm_python() {
	pkgdesc="Kanidm python module"
	depends="python3 $pkgname-clients"
	arch="noarch"
	
	# Copy Python module files
	install -dm755 "$subpkgdir"/usr/lib/kanidm/radius/
	install -Dm755 "$builddir"/rlm_python/radius_entrypoint.py "$subpkgdir"/usr/lib/kanidm/radius/radius_entrypoint.py
	cp -r "$builddir"/rlm_python/*.py "$subpkgdir"/usr/lib/kanidm/radius/ 2>/dev/null || true
}

sha512sums="
721e69591398a261c1eb302ef19fe8690c2bdd25cfc65f76237c95b60ce553ebba79e56ea6c6c2cf3835c17dcde951dee3f01717ea5e48300ff42d134dc10fd6  kanidm-1.9.0.tar.gz
db7a5663f84798b1b6dfacb2396f26cd24d45cf84a43c723f436f0af12146d6ae1675c90b628836d4dbb22d4361c8700a6b824886ce283768a5f29440ecdd4c5  initgroups-hooks.patch
08796634dacd038ec4f9e7a6d888a379a61819b4222a188bf6a9280dd122a259b315da6c75b59402dbdc97a72ca388ebf2985394b10cc90d1f209bb856d5cffd  jambox-server.base_htmx.patch
6dac7645e160c1e93ea6be69fd43e77887341058db1149ef19f8687d104b6a71759c01a4d0d7b2257294a5d0494bfa8c497e45faaa06fb567fb9259de5c91a36  release_alpine.toml
79f95a4f8ddd8bbfdeaf9480e032d186896e47d8c4b39b4ab5c005dab37c12e4ea1628eaa5055d36e3210ad9c1c949e1124f410d66098497ae2a2657482af120  kanidmd.initd
c9b2b200363034cfc930279be15d60b1cfcf68f4e9d9e491e1adf093b4ea0ad503644994569a6ca4b418cb50bf08239991665a8a52d7587af525db2041699467  kanidm-unixd.initd
08ab2aa7c1e8b14740172df89f3d265e1a7a06da083f65e8a296f7ac4cfdce7629b624d294a9de9bf4abf42769ca88efd10cb0edbbeb2320971b92d1bee393c0  kanidm-unixd-tasks.initd
6dec53d50389a7138163eeecef4dbcfe3a3cc474d33e66fcda65272b361219ffa43a59a042d5d59743e3a0b2df00ebcb273418920ebdc0354f52b22a9850bf5f  use-var-lib-kanidm.patch
b4cfa9b12969f9df88462c5b48105d3120b3538ea1392cfa653f58f2bebabcee2f0b5e6b7b6bc91f3c944ed3e0e5b74d1ddfaa6fc54c58d68be025bd58ea3efd  server-https-port.patch
"
